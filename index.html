<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>I Gettoni di Clizia</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, #fff2f8 0%, #fce7f3 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .title { font-size: 2.5rem; color: #ec4899; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
    .subtitle { font-size: 1.2rem; color: #be185d; }

    .btn {
      background: linear-gradient(135deg, #ec4899, #be185d);
      color: white; border: none; padding: 12px 22px; border-radius: 25px;
      font-size: 1rem; cursor: pointer; margin: 8px; transition: all 0.25s ease;
      box-shadow: 0 4px 15px rgba(236,72,153,0.3);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(236,72,153,0.4); }
    .btn-secondary { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

    /* Effetto pressione per i due pulsanti grandi */
    #masterActions > button:hover { transform: translateY(-3px) scale(1.02); }
    #masterActions > button:active { transform: translateY(0px) scale(0.98); }


    .mode-indicator {
      position: fixed; top: 20px; right: 20px;
      background: rgba(236,72,153,0.9); color:#fff; padding: 8px 12px;
      border-radius: 18px; font-size: 0.9rem; z-index: 100;
    }
    .parent-btn, .logout-btn, .change-pin-btn {
      position: fixed; right: 20px; color:#fff; border:none;
      padding: 8px 12px; border-radius: 18px; font-size:0.9rem; cursor:pointer;
      transition: all 0.25s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index:100;
    }
    .parent-btn { top: 62px; background: linear-gradient(135deg, #6b7280, #4b5563); }
    .change-pin-btn { top: 72px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .logout-btn { top: 152px; background: linear-gradient(135deg, #ef4444, #dc2626); }
    .parent-btn:hover, .logout-btn:hover, .change-pin-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .hidden { display: none !important; }

    .nav-tabs {
      display:flex; justify-content:center; margin:20px 0; background:#fff; border-radius:15px; padding:5px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .nav-tab {
      flex:1; padding:12px 16px; border:none; background:transparent; border-radius:10px;
      font-weight:700; cursor:pointer; color:#6b7280; transition: all 0.25s ease;
    }
    .nav-tab.active { background: linear-gradient(135deg, #ec4899, #be185d); color:#fff; box-shadow: 0 2px 10px rgba(236,72,153,0.3); }
    .nav-tab:hover:not(.active) { background:#f3f4f6; color:#374151; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .piggy-bank { width:200px; height:200px; margin:30px auto; position:relative; display:flex; align-items:center; justify-content:center; }
    .piggy-image { max-width:100%; max-height:100%; object-fit:contain; transition: all 0.3s ease; filter: drop-shadow(0 8px 25px rgba(255,179,217,0.4)); }
    .piggy-image:hover { transform: scale(1.05); }

    .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin: 30px 0; }
    .stat-card { background:#fff; border-radius:15px; padding:18px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .stat-number { font-size:2.2rem; font-weight:800; }
    .stat-label { color:#6b7280; margin-top: 5px; }

    .actions { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin: 20px 0; }
    #masterActions.actions { justify-content:center; }


    .note-input {
      width:100%; padding:12px 14px; border:2px solid #ec4899; border-radius:10px; margin:10px 0; font-family:inherit; resize:vertical;
    }

    .rewards { background:#fff; border-radius:15px; padding:20px; margin:20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .reward-item {
      border:2px solid #e5e7eb; border-radius:10px; margin:10px 0; padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .reward-available { border-color:#10b981; background:#f0fdf4; }
    .reward-claimed { border-color:#6b7280; background:#f9fafb; opacity:0.75; }

    .history { background:#fff; border-radius:15px; padding:20px; margin:20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .history-item { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f3f4f6; }
    .history-item:last-child { border-bottom:none; }
    .history-action { font-weight:700; }
    .history-action.positive { color:#10b981; }
    .history-action.negative { color:#ef4444; }
    .history-note { font-style:italic; color:#6b7280; margin-top: 4px; }

    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.45); z-index: 1000; padding: 20px; overflow:auto;
    }
    .modal-content {
      background:#fff; border-radius:18px; padding:24px; max-width:520px; margin: 60px auto; position:relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    }
    .close { position:absolute; top:12px; right:16px; font-size:1.8rem; cursor:pointer; color:#6b7280; }

    #confirmDeleteModal .modal-content {
      max-width: 420px;
      border: 3px solid #fecaca;
      box-shadow: 0 15px 40px rgba(239,68,68,0.25);
      text-align: center;
    }
    #confirmDeleteModal h3 { color:#ef4444; margin-bottom: 6px; }
    #confirmDeleteModal p { color:#374151; }

    .reward-icon { font-size: 1.5rem; margin-right: 10px; display:inline-flex; align-items:center; }

    .icon-picker { display:flex; flex-wrap:wrap; align-items:center; gap:12px; }
    
    .icon-grid {
      display: grid;
      width: 100%;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 10px;
      background-color: #f9fafb;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #f3f4f6;
    }
    .icon-option {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 50px;
      font-size: 1.8rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.2s ease, transform 0.2s ease;
      border: 2px solid transparent;
    }
    .icon-option:hover {
      background-color: #f3f4f6;
      transform: scale(1.1);
    }
    .icon-option.selected {
      border-color: #ec4899;
      background-color: #fff2f8;
      transform: scale(1.1);
    }
    .icon-option.special-icon {
      font-size: 1.4rem;
    }

    /* Contenitore per anteprima icona e nome (NUOVO) */
    .preview-container {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-top: 10px;
        padding: 8px;
        background-color: #f9fafb;
        border-radius: 12px;
        min-height: 60px;
    }
    .icon-preview {
      min-width:40px; min-height:40px; display:flex; align-items:center; justify-content:center;
      border:2px dashed #e5e7eb; border-radius:10px; padding:6px; background:#fff;
    }
    #iconNamePreview {
        font-weight: 700;
        font-size: 1rem;
        color: #be185d;
    }

    .lego-minifig { display:inline-block; width:24px; height:32px; vertical-align:middle; }

    #victoryModal .modal-content {
      max-width: 520px; text-align: center; border-radius: 24px; padding-bottom: 30px;
    }
    .victory-title {
      font-size: 1.8rem; color: #ec4899; margin-bottom: 6px;
      text-shadow: 1px 1px 2px rgba(236,72,153,0.2);
    }
    .victory-subtitle { color:#374151; margin-bottom: 16px; }
    .victory-image {
      width: 260px; height: 260px; object-fit: contain; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 10px auto 12px;
    }

    @media (max-width:768px){
      .title{ font-size:1.8rem; }
      .subtitle{ font-size:1rem; }
      .container { padding: 15px; }
      
      .mode-indicator { top: 15px; right: 15px; padding: 6px 10px; font-size: 0.8rem; }
      .parent-btn, .logout-btn, .change-pin-btn { right: 15px; font-size:0.8rem; padding: 6px 10px; }
      .parent-btn { top: 50px; }
      .change-pin-btn { top: 50px; }
      .logout-btn { top: 85px; }
      
      .piggy-bank { width:150px; height:150px; margin:20px auto; }
      
      .stats { grid-template-columns: 1fr; gap:15px; margin: 20px 0; }
      .stat-card { padding: 12px; }
      .stat-number { font-size: 1.8rem; }
      
      #masterActions.actions { 
        flex-direction: row !important; gap: 15px !important; justify-content: center !important;
        align-items: center; margin: 15px 0 !important;
      }
      #masterActions > button {
        width: 140px !important; height: 110px !important; font-size: 0.85rem !important;
      }
      #masterActions > button span:first-child { font-size: 1.4rem !important; }
      
      .nav-tabs { margin: 15px 0; padding: 3px; }
      .nav-tab { padding: 8px 12px; font-size: 0.9rem; }
      
      .rewards, .history { padding: 15px; margin: 15px 0; }
      .reward-item, .history-item { padding: 10px; margin: 8px 0; }
      .reward-item { flex-direction: column; align-items: flex-start; gap: 8px; }
      .reward-item > div:last-child { width: 100%; justify-content: space-between; }
      
      .modal { padding: 10px; }
      .modal-content { margin: 20px auto; padding: 20px; max-width: 95%; }
      
      .toast { bottom: 80px; }
      
      .victory-content { margin: 10px; padding: 25px; }
      .victory-title { font-size: 1.5rem; }
      .victory-message { font-size: 1rem; }
      .victory-image, .victory-content div[style*="font-size:6rem"] { 
        width: 200px !important; height: 200px !important; font-size: 4rem !important;
      }
      
      .btn { padding: 14px 20px; font-size: 1rem; min-height: 48px; width: auto; }
      
      .icon-picker { flex-direction: column; align-items: stretch; gap: 8px; }
      .preview-container { align-self: center; width: auto; padding: 8px 20px; }
      
      .note-input { padding: 14px; font-size: 1rem; }
    }
    
        .coin-animation {
            position: absolute; top: -60px; left: 50%;
            transform: translateX(-50%); z-index: 10; opacity: 0;
            width: 35px; height: 35px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #fbbf24, #f59e0b, #d97706);
            border-radius: 50%; border: 3px solid #92400e;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4), inset 0 2px 5px rgba(255,255,255,0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: #92400e;
        }
        .coin-inserting { animation: coinInsert 2.5s ease-in-out; }
        @keyframes coinInsert {
            0% { top: -60px; opacity: 0; transform: translateX(-50%) rotate(0deg) scale(0.8); }
            15% { opacity: 1; transform: translateX(-50%) rotate(180deg) scale(1); box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6), inset 0 2px 5px rgba(255,255,255,0.4), 0 0 25px rgba(255, 215, 0, 0.8); }
            30% { transform: translateX(-50%) rotate(360deg) scale(1.1); box-shadow: 0 8px 25px rgba(255, 215, 0, 0.8), inset 0 2px 5px rgba(255,255,255,0.6), 0 0 35px rgba(255, 215, 0, 1); }
            50% { top: -20px; transform: translateX(-50%) rotate(540deg) scale(1); }
            70% { top: -5px; transform: translateX(-50%) rotate(720deg) scale(0.9); }
            85% { top: 5px; transform: translateX(-50%) rotate(900deg) scale(0.7); opacity: 0.8; }
            100% { top: 20px; opacity: 0; transform: translateX(-50%) rotate(1080deg) scale(0.3); }
        }
        @keyframes coinExitFromBottom {
            0% { top: 80px; left: 50%; transform: translateX(-50%) rotate(0deg) scale(1); opacity: 1; }
            25% { top: 120px; transform: translateX(-50%) rotate(-180deg) scale(0.9); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4); }
            50% { top: 160px; transform: translateX(-50%) rotate(-360deg) scale(0.8); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6); }
            75% { top: 200px; transform: translateX(-50%) rotate(-540deg) scale(0.6); opacity: 0.7; }
            100% { top: 250px; left: 50%; transform: translateX(-50%) rotate(-720deg) scale(0.3); opacity: 0; }
        }

        .victory-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.5s ease-in-out; }
        .victory-content { background: white; border-radius: 30px; padding: 40px; text-align: center; max-width: 600px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: bounceIn 0.8s ease-out; }
        .victory-title { font-size: 2rem; color: #ec4899; margin-bottom: 12px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .victory-image { width: 360px; height: 360px; object-fit: contain; margin: 20px 0; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .victory-reward-name { color: #f59e0b; text-shadow: 2px 2px 4px rgba(245,158,11,0.3); font-weight: bold; }
        .victory-message { font-size: 1.2rem; color: #10b981; line-height: 1.6; font-weight: bold; text-shadow: 1px 1px 2px rgba(16,185,129,0.2); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.3) rotate(-10deg); opacity: 0; } 50% { transform: scale(1.05) rotate(2deg); } 70% { transform: scale(0.9) rotate(-1deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .notification-banner { 
          position: fixed; bottom: 20px; right: 20px; 
          background: linear-gradient(135deg, #10b981, #059669); color: #fff; 
          padding: 12px 18px; border-radius: 12px; 
          box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); 
          font-weight: 700; font-size: 0.9rem;
          max-width: 280px; z-index: 4000; opacity: 0; 
          transform: translateX(100px);
          transition: all 0.4s ease;
          pointer-events: none;
        }
        .notification-banner.show { opacity: 1; transform: translateX(0); }
        .notification-banner.error { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3); }
        .notification-banner.success { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); }
        .notification-banner.info { background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }
        .notification-banner.warning { background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3); }
</style>
</head>
<body>
  <div class="mode-indicator" id="modeIndicator">Modalit√† Clizia</div>
  <button class="parent-btn" id="parentBtn" onclick="showLoginModal()">üë®‚Äçüë©‚Äçüëß Genitore</button>
  <button class="change-pin-btn hidden" id="changePinTopBtn" onclick="showSettingsModal()">‚öôÔ∏è Impostazioni</button>
  <button class="logout-btn hidden" id="logoutBtn" onclick="logout()">üö™ Logout</button>

  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('loginModal')">&times;</span>
      <h3>üë®‚Äçüë©‚Äçüëß Accesso Genitore</h3>
      <p>Inserisci il PIN per accedere in modalit√† Master</p>
      <input type="password" id="pinInput" class="note-input" placeholder="PIN" maxlength="4">
      <p id="pinError" style="color:#ef4444; font-weight:700; font-size:0.9rem; margin-top:4px; display:none;">PIN errato, ritenta!</p>
      <div class="actions" style="margin-top:6px;">
        <button onclick="checkPin()" class="btn">Accedi</button>
      </div>
    </div>
  </div>

  <div id="mainApp" class="container hidden">
    <div class="header">
      <h1 class="title">üê∑ I Gettoni di Clizia ü™ô</h1>
      <p class="subtitle">Ogni buona azione merita un premio!</p>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('salvadanaio')">üê∑ Salvadanaio</button>
      <button class="nav-tab" onclick="showTab('premi')">üéÅ Premi</button>
      <button class="nav-tab" onclick="showTab('cronologia')">üìú Cronologia</button>
    </div>

    <div id="salvadanaioTab" class="tab-content active">
      <div class="piggy-bank">
        <img src="https://i.imgur.com/3j3qHHV.png" alt="Porcellino di Clizia" class="piggy-image" onerror="this.outerHTML='<div style=\'font-size:8rem;opacity:0.8;filter:drop-shadow(0 8px 25px rgba(255,179,217,0.4));transition:all 0.3s ease;\'>üê∑</div>';">
      </div>

      <div class="stats">
        <div class="stat-card"><div class="stat-number" id="totalCoins" style="color:#10b981;">0</div><div class="stat-label">Gettoni Totali</div></div>
        <div class="stat-card"><div class="stat-number" id="goodActions" style="color:#8b5cf6;">0</div><div class="stat-label">Buone Azioni</div></div>
        <div class="stat-card"><div class="stat-number" id="badActions">0</div><div class="stat-label">Marachelle</div></div>
      </div>

      <div class="actions hidden" id="masterActions" style="justify-content:center; gap:144px; margin: 18px 0;">
        <button onclick="showAddCoinModal()" aria-label="Aggiungi Gettone" style="width:160px; height:160px; border:none; border-radius:26px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; background:linear-gradient(135deg,#10b981,#059669); color:#fff; box-shadow:0 12px 30px rgba(16,185,129,0.35); font-weight:800; font-size:1.05rem; transition:transform .15s ease, box-shadow .15s ease;">
          <span style="font-size:2rem;">üíñ</span>
          <span>Aggiungi Gettone</span>
        </button>
        <button onclick="showRemoveCoinModal()" aria-label="Rimuovi Gettone" style="width:160px; height:160px; border:none; border-radius:26px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; box-shadow:0 12px 30px rgba(239,68,68,0.35); font-weight:800; font-size:1.05rem; transition:transform .15s ease, box-shadow .15s ease;">
          <span style="font-size:2rem;">‚ö°</span>
          <span>Rimuovi Gettone</span>
        </button>
      </div>
    </div>

    <div id="premiTab" class="tab-content">
      <div class="actions hidden" id="rewardsManagementActions" style="margin-bottom: 10px;">
        <button onclick="showRewardsModal()" class="btn btn-secondary">‚ûï Aggiungi Premi</button>
      </div>
      <div class="rewards">
        <h3>üéÅ Premi Disponibili</h3>
        <div id="rewardsList"></div>
      </div>
    </div>

    <div id="cronologiaTab" class="tab-content">
      <div class="history">
        <h3>üìú Cronologia</h3>
        <div id="historyList"></div>
      </div>
    </div>
  </div>

  <div id="addCoinModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('addCoinModal')">&times;</span>
      <h3>‚ûï Aggiungi Gettone</h3>
      <textarea id="addNote" class="note-input" placeholder="Descrivi la buona azione di Clizia..."></textarea>
      <div class="actions"><button onclick="addCoin()" class="btn">Aggiungi Gettone</button></div>
    </div>
  </div>

  <div id="removeCoinModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('removeCoinModal')">&times;</span>
      <h3>‚ûñ Rimuovi Gettone</h3>
      <textarea id="removeNote" class="note-input" placeholder="Descrivi la marachella..."></textarea>
      <div class="actions"><button onclick="removeCoin()" class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Rimuovi Gettone</button></div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('settingsModal')">&times;</span>
      <h3>‚öôÔ∏è Impostazioni</h3>
      
      <h4 style="margin-top:20px; margin-bottom:10px;">Cambia PIN</h4>
      <input type="password" id="newPin" class="note-input" placeholder="Nuovo PIN (4 cifre)" maxlength="4">
      <div class="actions">
        <button onclick="changePin()" class="btn">Cambia PIN</button>
      </div>
      
      <hr style="margin:25px 0; border:none; border-top:1px solid #e5e7eb;">
      
      <h4 style="margin-bottom:10px; color:#ef4444;">‚ö†Ô∏è Zona Pericolo</h4>
      <p style="color:#6b7280; font-size:0.9rem; margin-bottom:15px;">Questa azione eliminer√† tutti i dati dell'app in modo permanente.</p>
      <div class="actions">
        <button onclick="showResetConfirmation()" class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);">‚ò†Ô∏è Resetta Tutto</button>
      </div>
    </div>
  </div>

  <div id="rewardsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('rewardsModal')">&times;</span>
      <h3>üéÅ Gestisci Premi</h3>
      <h4 style="margin-top:6px;">Aggiungi o Modifica Premio</h4>
      <input type="text" id="rewardName" class="note-input" placeholder="Nome del premio">
      <input type="number" id="rewardCoins" class="note-input" placeholder="Gettoni necessari" min="1">
      <div class="icon-picker">
        <label style="font-weight:700; width: 100%;">Seleziona un'icona:</label>
        <div class="icon-grid">
          <div class="icon-option" data-icon="‚≠ê">‚≠ê</div>
          <div class="icon-option" data-icon="üíñ">üíñ</div>
          <div class="icon-option" data-icon="üéÅ">üéÅ</div>
          <div class="icon-option" data-icon="üëë">üëë</div>
          <div class="icon-option" data-icon="ü¶Ñ">ü¶Ñ</div>
          <div class="icon-option" data-icon="üòä">üòä</div>
          <div class="icon-option" data-icon="üåü">üåü</div>
          <div class="icon-option" data-icon="üéà">üéà</div>
          <div class="icon-option" data-icon="üç≠">üç≠</div>
          <div class="icon-option" data-icon="üé™">üé™</div>
          <div class="icon-option" data-icon="üç¶">üç¶</div>
          <div class="icon-option" data-icon="üé¨">üé¨</div>
          <div class="icon-option" data-icon="üåà">üåà</div>
          <div class="icon-option" data-icon="üì∫">üì∫</div>
          <div class="icon-option" data-icon="üéÆ">üéÆ</div>
          <div class="icon-option" data-icon="üß∏">üß∏</div>
          <div class="icon-option" data-icon="üé®">üé®</div>
          <div class="icon-option" data-icon="üçï">üçï</div>
          <div class="icon-option" data-icon="üöÄ">üöÄ</div>
          <div class="icon-option" data-icon="üìñ">üìñ</div>
          <div class="icon-option" data-icon="üéÇ">üéÇ</div>
          <div class="icon-option" data-icon="üéâ">üéâ</div>
          <div class="icon-option" data-icon="üçø">üçø</div>
          <div class="icon-option special-icon" data-icon="LEGO_MINIFIG">üß±</div>
        </div>
        <div class="preview-container">
            <div id="iconPreview" class="icon-preview"></div>
            <span id="iconNamePreview"></span>
        </div>
      </div>
      <div class="actions"><button id="rewardSubmitBtn" onclick="addReward()" class="btn">Aggiungi Premio</button></div>
    </div>
  </div>

  <div id="confirmResetModal" class="modal">
    <div class="modal-content" style="max-width: 450px; border: 3px solid #fecaca; box-shadow: 0 15px 40px rgba(239,68,68,0.25); text-align: center;">
      <span class="close" onclick="closeConfirmReset()">&times;</span>
      <h3 style="color:#ef4444; margin-bottom: 15px;">‚ö†Ô∏è Conferma Reset Completo</h3>
      <p style="color:#374151; margin-bottom: 20px; line-height: 1.5;">
        Sei sicuro di voler <strong>resettare completamente</strong> l'app?<br><br>
        <strong style="color:#ef4444;">Verranno eliminati:</strong><br>
        ‚Ä¢ Tutti i gettoni e statistiche<br>
        ‚Ä¢ Tutti i premi personalizzati<br>
        ‚Ä¢ Tutta la cronologia<br>
        ‚Ä¢ Il PIN torner√† a "1234"
      </p>
      <div class="actions" style="justify-content:center; gap:15px;">
        <button class="btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);" onclick="confirmReset()">‚ò†Ô∏è S√¨, Resetta Tutto</button>
        <button class="btn btn-secondary" onclick="closeConfirmReset()">‚ùå Annulla</button>
      </div>
    </div>
  </div>

  <div id="confirmDeleteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConfirmDelete()">&times;</span>
      <h3>Elimina premio</h3>
      <p id="confirmDeleteText" style="margin-top: 8px;">Sei sicuro di voler eliminare questo premio?</p>
      <div class="actions" style="justify-content:center;">
        <button class="btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);" onclick="confirmDelete()">Elimina</button>
        <button class="btn btn-secondary" onclick="closeConfirmDelete()">Annulla</button>
      </div>
    </div>
  </div>

    <div id="victoryOverlay" class="victory-overlay">
      <div class="victory-content">
        <div class="victory-title" id="victoryTitle">Congratulazioni Clizia!</div>
        <img src="https://i.imgur.com/6meUeMB.png" alt="Vittoria!" class="victory-image" onerror="this.outerHTML='<div style=\'font-size:6rem;margin:20px 0;\'>üéâ‚ú®üèÜ‚ú®üéâ</div>';">
        <div class="victory-message" id="victoryMessage">Sei stata fantastica, continua cos√¨ e raggiungerai presto nuovi traguardi!</div>
      </div>
    </div>

  <script>
    let currentMode = 'child';
    let currentTab = 'salvadanaio';
    let appData = {
      totalCoins: 0, goodActions: 0, badActions: 0,
      history: [],
      rewards: [
        { name: "Gelato speciale", coins: 5, claimed: false, icon: "üç¶" },
        { name: "Film al cinema", coins: 10, claimed: false, icon: "üé¨" },
        { name: "Giocattolo nuovo", coins: 15, claimed: false, icon: "üß∏" }
      ],
      pin: "1234"
    };

    // (NUOVO) Mappa delle icone per visualizzare il nome
    const iconMap = {
        '‚≠ê': 'Stella', 'üíñ': 'Cuore', 'üéÅ': 'Regalo', 'üëë': 'Corona',
        'ü¶Ñ': 'Unicorno', 'üòä': 'Sorriso', 'üåü': 'Stellina', 'üéà': 'Palloncino',
        'üç≠': 'Lecca-lecca', 'üé™': 'Spettacolo', 'üç¶': 'Gelato', 'üé¨': 'Cinema',
        'üåà': 'Arcobaleno', 'üì∫': 'Televisione', 'üéÆ': 'Gioco', 'üß∏': 'Orsetto',
        'üé®': 'Tavolozza', 'üçï': 'Pizza', 'üöÄ': 'Viaggio', 'üìñ': 'Libro',
        'üéÇ': 'Torta', 'LEGO_MINIFIG': 'Lego', 'üéâ': 'Festa', 'üçø': 'Pop corn'
    };

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        switch(type) {
          case 'coinAdd':
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(660, audioContext.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
            break;
          case 'coinRemove':
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.4);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.4);
            break;
          case 'victory':
            const frequencies = [523, 659, 784, 1047];
            frequencies.forEach((freq, index) => {
              setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc.start();
                osc.stop(audioContext.currentTime + 0.5);
              }, index * 150);
            });
            break;
          case 'errorPin':
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(100, audioContext.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
            break;
        }
      } catch(e) { console.log('Audio non supportato'); }
    }

    function legoMinifigSVG() {
      return `<svg class="lego-minifig" viewBox="0 0 24 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="6" y="2" width="12" height="10" rx="2" fill="#FFD700" stroke="#E6C200" stroke-width="0.5"/><rect x="9" y="0" width="6" height="3" rx="1" fill="#FFD700" stroke="#E6C200" stroke-width="0.5"/><circle cx="10.5" cy="1.5" r="0.8" fill="#E6C200"/><circle cx="13.5" cy="1.5" r="0.8" fill="#E6C200"/><circle cx="9" cy="6" r="1" fill="#000"/><circle cx="15" cy="6" r="1" fill="#000"/><path d="M 10 9 Q 12 10.5 14 9" stroke="#000" stroke-width="0.8" fill="none" stroke-linecap="round"/><rect x="5" y="12" width="14" height="12" fill="#DC143C" stroke="#B91C3C" stroke-width="0.5"/><rect x="2" y="14" width="3" height="8" rx="1.5" fill="#FFD700" stroke="#E6C200" stroke-width="0.5"/><rect x="19" y="14" width="3" height="8" rx="1.5" fill="#FFD700" stroke="#E6C200" stroke-width="0.5"/><path d="M 1 20 Q 1 22 3 22 Q 5 22 5 20" stroke="#FFD700" stroke-width="1.5" fill="none"/><path d="M 19 20 Q 19 22 21 22 Q 23 22 23 20" stroke="#FFD700" stroke-width="1.5" fill="none"/><rect x="5" y="24" width="14" height="6" fill="#1E40AF" stroke="#1E3A8A" stroke-width="0.5"/><rect x="7" y="30" width="4" height="2" fill="#1E40AF"/><rect x="13" y="30" width="4" height="2" fill="#1E40AF"/></svg>`;
    }
    function iconHTML(val) {
      if (val === 'LEGO_MINIFIG') return legoMinifigSVG();
      return val || 'üéÅ';
    }
    window.updateIconPreview = function(val) {
      const preview = document.getElementById('iconPreview');
      const namePreview = document.getElementById('iconNamePreview');
      if (!preview || !namePreview) return;

      preview.innerHTML = '';
      if (val === 'LEGO_MINIFIG') {
        preview.innerHTML = legoMinifigSVG();
      } else {
        preview.textContent = val || 'üéÅ';
        preview.style.fontSize = '2rem';
      }
      
      namePreview.textContent = iconMap[val] || '';
      
      document.querySelectorAll('.icon-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.icon === val) {
          opt.classList.add('selected');
        }
      });
    };

    let selectedIcon = '‚≠ê';

    function setupIconGrid() {
      document.querySelectorAll('.icon-option').forEach(option => {
        option.addEventListener('click', function() {
          selectedIcon = this.dataset.icon;
          updateIconPreview(selectedIcon);
        });
      });
    }

    window.showLoginModal = () => document.getElementById('loginModal').style.display = 'block';
    window.closeModal = (id) => {
      const m = document.getElementById(id);
      if (m) m.style.display = 'none';
      const inputs = document.querySelectorAll(`#${id} input, #${id} textarea`);
      inputs.forEach(i => i.value = '');
      if (id === 'rewardsModal') {
        const btn = document.getElementById('rewardSubmitBtn');
        btn.textContent = 'Aggiungi Premio';
        btn.onclick = addReward;
      }
    };

    let pendingDeleteIndex = null;
    window.openConfirmDelete = function(index) {
      pendingDeleteIndex = index;
      const reward = appData.rewards[index];
      const txt = document.getElementById('confirmDeleteText');
      if (txt && reward) txt.innerHTML = `Vuoi davvero eliminare <strong>${reward.name}</strong>?`;
      document.getElementById('confirmDeleteModal').style.display = 'block';
    };
    window.closeConfirmDelete = function() {
      pendingDeleteIndex = null;
      document.getElementById('confirmDeleteModal').style.display = 'none';
    };
    window.confirmDelete = function() {
      if (pendingDeleteIndex === null) { closeConfirmDelete(); return; }
      const idx = pendingDeleteIndex;
      if (idx < 0 || idx >= appData.rewards.length) { closeConfirmDelete(); return; }
      const rewardName = appData.rewards[idx].name;
      appData.rewards.splice(idx, 1);
      closeConfirmDelete();
      updateRewards();
      updateDisplay();
      showBanner(`üóëÔ∏è Premio "${rewardName}" eliminato`, 'warning');
      saveData();
    };

    window.checkPin = function() {
      const pin = document.getElementById('pinInput').value;
      if (pin === appData.pin) {
        currentMode = 'master';
        document.getElementById('pinError').style.display = 'none';
        closeModal('loginModal');
        updateModeDisplay();
        updateDisplay();
        showBanner('üîì Accesso Master autorizzato', 'success');
        window.__pinAttempts = 0;
      } else {
        window.__pinAttempts = (window.__pinAttempts || 0) + 1;
        const err = document.getElementById('pinError');
        if (err) err.style.display = 'block';
        document.getElementById('pinInput').value = '';
        playSound('errorPin');
        if (window.__pinAttempts === 3) {
          appData.history.unshift({ type:'loginFail', note:'..pi√π tentativi falliti in accesso master..', timestamp:new Date().toLocaleString('it-IT') });
          if (appData.history.length > 50) appData.history = appData.history.slice(0,50);
          updateHistory();
          saveData();
          showToast('3 tentativi falliti', 'error');
        }
      }
    };

    window.logout = function() {
      currentMode = 'child';
      updateModeDisplay();
      document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
      currentTab = 'salvadanaio';
      document.querySelectorAll('.tab-content').forEach(t => { t.classList.remove('active'); t.style.display='none'; });
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      const tEl = document.getElementById('salvadanaioTab');
      if (tEl) { tEl.classList.add('active'); tEl.style.display='block'; }
      const firstTab = document.querySelector('.nav-tab');
      if (firstTab) firstTab.classList.add('active');
      showBanner('üëã Uscita da modalit√† Master', 'info');
      updateDisplay();
    };

    function updateModeDisplay() {
      const modeIndicator = document.getElementById('modeIndicator');
      const parentBtn = document.getElementById('parentBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const masterActions = document.getElementById('masterActions');
      const rewardsManagementActions = document.getElementById('rewardsManagementActions');

      if (currentMode === 'master') {
        modeIndicator.textContent = 'Modalit√† Master';
        parentBtn.classList.add('hidden');
        document.getElementById('changePinTopBtn').classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        masterActions.classList.remove('hidden');
        rewardsManagementActions.classList.remove('hidden');
      } else {
        modeIndicator.textContent = 'Modalit√† Clizia';
        parentBtn.classList.remove('hidden');
        document.getElementById('changePinTopBtn').classList.add('hidden');
        logoutBtn.classList.add('hidden');
        masterActions.classList.add('hidden');
        rewardsManagementActions.classList.add('hidden');
      }
    }

    window.showTab = function(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-content').forEach(t => { t.classList.remove('active'); t.style.display='none'; });
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      const content = document.getElementById(tab + 'Tab');
      if (content) { content.classList.add('active'); content.style.display='block'; }
      const clicked = Array.from(document.querySelectorAll('.nav-tab')).find(b => b.textContent.includes(tab === 'salvadanaio' ? 'Salvadanaio' : tab === 'premi' ? 'Premi' : 'Cronologia'));
      if (clicked) clicked.classList.add('active');
      updateDisplay();
    };

    window.animatePiggy = function() {
      const piggy = document.querySelector('.piggy-image');
      if (!piggy) return;
      piggy.animate([ { transform: 'scale(1) rotate(0deg)' }, { transform: 'scale(1.08) rotate(5deg)' }, { transform: 'scale(1) rotate(0deg)' } ], { duration: 300, easing: 'ease-in-out' } );
    };
    window.animatePiggyShake = function() {
      const piggy = document.querySelector('.piggy-image');
      if (!piggy) return;
      piggy.animate([ { transform: 'translateX(0) rotate(0deg)' }, { transform: 'translateX(-5px) rotate(-2deg)' }, { transform: 'translateX(5px) rotate(2deg)' }, { transform: 'translateX(-4px) rotate(-1deg)' }, { transform: 'translateX(4px) rotate(1deg)' }, { transform: 'translateX(0) rotate(0deg)' } ], { duration: 700, easing: 'ease-in-out' });
    };
    window.animateCoin = function(isAdding) {
      const piggyBank = document.querySelector('.piggy-bank');
      if (!piggyBank) return;
      if (isAdding) {
        const coin = document.createElement('div');
        coin.className = 'coin-animation coin-inserting';
        coin.textContent = 'ü™ô';
        piggyBank.appendChild(coin);
        setTimeout(() => { coin.remove(); }, 2500);
      } else {
        animatePiggyShake();
        setTimeout(() => {
          const coin = document.createElement('div');
          coin.className = 'coin-animation';
          coin.textContent = 'ü™ô';
          coin.style.top = '80px';
          coin.style.bottom = 'auto';
          coin.style.left = '50%';
          coin.style.transform = 'translateX(-50%)';
          coin.style.background = 'radial-gradient(circle at 30% 30%, #ef4444, #dc2626, #b91c1c)';
          coin.style.animation = 'coinExitFromBottom 2s ease-in-out';
          piggyBank.appendChild(coin);
          setTimeout(() => { coin.remove(); }, 2000);
        }, 500);
      }
    };

    window.showAddCoinModal = () => document.getElementById('addCoinModal').style.display='block';
    window.showRemoveCoinModal = () => {
      if (appData.totalCoins <= 0) { showToast('Nessun gettone da rimuovere', 'error'); return; }
      document.getElementById('removeCoinModal').style.display='block';
    };
    window.showSettingsModal = () => { const m=document.getElementById('settingsModal'); if(m){ m.style.display='block'; const i=document.getElementById('newPin'); if(i){ i.value=''; setTimeout(()=>i.focus(),50); } } }

    window.showResetConfirmation = function() { document.getElementById('confirmResetModal').style.display = 'block'; };
    window.closeConfirmReset = function() { document.getElementById('confirmResetModal').style.display = 'none'; };
    window.confirmReset = function() {
      appData = {
        totalCoins: 0, goodActions: 0, badActions: 0, history: [],
        rewards: [
          { name: "Gelato speciale", coins: 5, claimed: false, icon: "üç¶" },
          { name: "Film al cinema", coins: 10, claimed: false, icon: "üé¨" },
          { name: "Giocattolo nuovo", coins: 15, claimed: false, icon: "üß∏" }
        ],
        pin: "1234"
      };
      closeConfirmReset();
      closeModal('settingsModal');
      currentMode = 'child';
      updateModeDisplay();
      showTab('salvadanaio');
      updateDisplay();
      saveData();
      showBanner('‚ò†Ô∏è App resettata completamente!', 'warning');
    };

    window.addCoin = function() {
      const note = document.getElementById('addNote').value || 'Buona azione!';
      closeModal('addCoinModal');
      appData.totalCoins++; appData.goodActions++;
      appData.history.unshift({ type:'add', note, timestamp: new Date().toLocaleString('it-IT') });
      if (appData.history.length > 50) appData.history = appData.history.slice(0,50);
      showBanner('üíñ Gettone aggiunto! Brava Clizia!', 'success');
      playSound('coinAdd');
      animateCoin(true);
      animatePiggy();
      checkForVictory();
      updateDisplay();
      saveData();
    };

    window.removeCoin = function() {
      if (appData.totalCoins <= 0) { showBanner('Nessun gettone da rimuovere', 'error'); return; }
      const note = document.getElementById('removeNote').value || 'Marachella!';
      closeModal('removeCoinModal');
      appData.totalCoins--; appData.badActions++;
      appData.history.unshift({ type:'remove', note, timestamp: new Date().toLocaleString('it-IT') });
      if (appData.history.length > 50) appData.history = appData.history.slice(0,50);
      showBanner('‚ö° Gettone rimosso. Cerca di fare meglio!', 'warning');
      playSound('coinRemove');
      animateCoin(false);
      updateDisplay();
      saveData();
    };

    window.changePin = function(e) {
      if (e && e.preventDefault) e.preventDefault();
      const newPin = document.getElementById('newPin').value;
      if (!/^\d{4}$/.test(newPin)) return;
      appData.pin = newPin;
      closeModal('settingsModal');
      currentMode = 'child';
      updateModeDisplay();
      showTab('salvadanaio');
      showBanner('üîí PIN modificato con successo', 'info');
      saveData();
    };

    window.showRewardsModal = function() {
      document.getElementById('rewardsModal').style.display = 'block';
      const btn = document.getElementById('rewardSubmitBtn'); btn.textContent = 'Aggiungi Premio'; btn.onclick = addReward;
      selectedIcon = '‚≠ê';
      updateIconPreview(selectedIcon);
      setTimeout(() => setupIconGrid(), 100);
    };
    window.addReward = function() {
      const name = document.getElementById('rewardName').value.trim();
      const coins = parseInt(document.getElementById('rewardCoins').value, 10);
      const icon = selectedIcon;
      if (!name || !coins || coins < 1) { showBanner('Dati premio non validi', 'error'); return; }
      appData.rewards.push({ name, coins, claimed:false, icon });
      closeModal('rewardsModal');
      updateRewards(); updateDisplay();
      showBanner(`üéÅ Premio "${name}" aggiunto!`, 'success');
      saveData();
    };
    window.editReward = function(index) {
      const r = appData.rewards[index];
      document.getElementById('rewardName').value = r.name;
      document.getElementById('rewardCoins').value = r.coins;
      selectedIcon = r.icon || 'üéÅ';
      updateIconPreview(selectedIcon);
      const btn = document.getElementById('rewardSubmitBtn');
      btn.textContent = 'Modifica Premio';
      btn.onclick = () => updateReward(index);
      document.getElementById('rewardsModal').style.display = 'block';
      setTimeout(() => setupIconGrid(), 100);
    };
    window.updateReward = function(index) {
      const name = document.getElementById('rewardName').value.trim();
      const coins = parseInt(document.getElementById('rewardCoins').value, 10);
      const icon = selectedIcon;
      if (!name || !coins || coins < 1) { showBanner('Dati premio non validi', 'error'); return; }
      appData.rewards[index] = { ...appData.rewards[index], name, coins, icon };
      closeModal('rewardsModal');
      updateRewards(); updateDisplay();
      showBanner(`‚úèÔ∏è Premio "${name}" modificato!`, 'info');
      saveData();
    };
    window.claimReward = function(index) {
      const reward = appData.rewards[index];
      if (reward.claimed) { showBanner('Premio gi√† riscattato', 'error'); return; }
      if (appData.totalCoins < reward.coins) {
        showBanner(`Servono ${reward.coins} gettoni, ne hai ${appData.totalCoins}`, 'error');
        return;
      }
      appData.totalCoins -= reward.coins;
      reward.claimed = true;
      appData.history.unshift({ type:'reward', note:`Premio riscattato: ${reward.name}`, rewardIcon: reward.icon, timestamp:new Date().toLocaleString('it-IT') });
      if (appData.history.length > 50) appData.history = appData.history.slice(0,50);
      updateDisplay();
      showBanner(`üèÜ Congratulazioni! Hai riscattato "${reward.name}"!`, 'success');
      showVictoryCelebration(reward, 'ottenuto');
      saveData();
    };

    function showVictoryCelebration(reward, action = 'raggiunto') {
      const overlay = document.getElementById('victoryOverlay');
      const title = document.getElementById('victoryTitle');
      const message = document.getElementById('victoryMessage');
      title.innerHTML = `Congratulazioni Clizia! Hai ${action} <span class="victory-reward-name">${reward.name}</span>`;
      message.textContent = 'Sei stata fantastica, continua cos√¨ e raggiungerai presto nuovi traguardi!';
      playSound('victory');
      overlay.style.display = 'flex';
      setTimeout(() => {
        overlay.style.animation = 'fadeOut 1s ease-in-out';
        setTimeout(() => {
          overlay.style.display = 'none';
          overlay.style.animation = '';
        }, 1000);
      }, 9000);
    }
    function checkForVictory() {
      const available = appData.rewards
        .filter(r => !r.claimed && r.coins === appData.totalCoins)
        .sort((a,b)=>a.coins-b.coins);
      if (available.length > 0) {
        showVictoryCelebration(available[0], 'raggiunto');
      }
    }

    function updateDisplay() {
      document.getElementById('totalCoins').textContent = appData.totalCoins;
      document.getElementById('goodActions').textContent = appData.goodActions;
      document.getElementById('badActions').textContent = appData.badActions;
      const masterActions = document.getElementById('masterActions');
      const rewardsManagementActions = document.getElementById('rewardsManagementActions');
      if (currentMode === 'master') {
        masterActions.classList.remove('hidden');
        rewardsManagementActions.classList.remove('hidden');
      } else {
        masterActions.classList.add('hidden');
        rewardsManagementActions.classList.add('hidden');
      }
      updateHistory();
      updateRewards();
    }

    function updateHistory() {
      const list = document.getElementById('historyList');
      if (!list) return;
      if (appData.history.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#6b7280;">Nessuna azione ancora registrata</p>';
        return;
      }
      list.innerHTML = appData.history.slice(0,50).map(item => `
        <div class="history-item">
          <div>
            <div class="history-action ${item.type === 'add' ? 'positive' : item.type === 'remove' ? 'negative' : item.type === 'loginFail' ? 'negative' : ''}">
              ${item.type === 'add' ? 'üíñ Gettone aggiunto' :
                 item.type === 'remove' ? '‚ö° Gettone rimosso' :
                 item.type === 'loginFail' ? 'üò† Login fallito' :
                 `${iconHTML(item.rewardIcon || 'üéÅ')} Premio riscattato`}
            </div>
            <div class="history-note">${item.note}</div>
          </div>
          <div style="font-size:0.9rem; color:#6b7280;">${item.timestamp}</div>
        </div>
      `).join('');
    }

    function updateRewards() {
      const container = document.getElementById('rewardsList');
      if (!container) return;
      if (appData.rewards.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#6b7280;">Nessun premio configurato</p>';
        return;
      }
      const sorted = [...appData.rewards].sort((a,b)=>a.coins-b.coins);
      container.innerHTML = sorted.map(reward=>{
        const originalIndex = appData.rewards.findIndex(r=>r===reward);
        const canClaim = appData.totalCoins >= reward.coins && !reward.claimed;
        const isClaimed = reward.claimed;
        const leftBox = `<div style="display:flex; align-items:center; gap:8px;"><span class="reward-icon">${iconHTML(reward.icon)}</span><strong>${reward.name}</strong></div>`;
        let rightBox = `<div style="display:flex; align-items:center; gap:10px;"><div style="color:#6b7280;">${reward.coins} gettoni</div>`;

        if (currentMode === 'master') {
          if (isClaimed) {
            rightBox += `<button onclick="openConfirmDelete(${originalIndex})" class="btn" title="Elimina premio" style="padding:6px 12px; font-size:0.85rem; background:linear-gradient(135deg,#ef4444,#dc2626)">üóëÔ∏è</button><span style="color:#6b7280;">‚úÖ Riscattato</span>`;
          } else {
            rightBox += `<button onclick="editReward(${originalIndex})" class="btn" title="Modifica" style="padding:6px 12px; font-size:0.85rem; background:linear-gradient(135deg,#f59e0b,#d97706)">‚úèÔ∏è</button>`;
            rightBox += `<button onclick="openConfirmDelete(${originalIndex})" class="btn" title="Elimina premio" style="padding:6px 12px; font-size:0.85rem; background:linear-gradient(135deg,#ef4444,#dc2626)">üóëÔ∏è</button>`;
            rightBox += canClaim ? `<span style="color:#10b981; font-weight:700;">‚úÖ Disponibile</span>` : '';
          }
        } else {
          if (isClaimed) {
            rightBox += `<span style="color:#6b7280;">‚úÖ Riscattato</span>`;
          } else {
            rightBox += canClaim
              ? `<button onclick="claimReward(${originalIndex})" class="btn" style="padding:8px 16px; font-size:0.95rem; background:linear-gradient(135deg,#10b981,#059669)">üéÅ Riscatta</button>`
              : `<span style="color:#6b7280;">Servono ${reward.coins - appData.totalCoins} gettoni</span>`;
          }
        }
        rightBox += `</div>`;
        return `<div class="reward-item ${canClaim ? 'reward-available' : ''} ${isClaimed ? 'reward-claimed' : ''}">${leftBox}${rightBox}</div>`;
      }).join('');
    }

    function saveData(){ 
      try { localStorage.setItem('cliziaAppData', JSON.stringify(appData)); } catch(e) { console.error('Save error', e); }
    }
    function loadData(){
      try {
        const saved = localStorage.getItem('cliziaAppData');
        if (saved) { appData = { ...appData, ...JSON.parse(saved) }; }
      } catch(e) { console.error('Load error', e); }
      
      document.getElementById('mainApp').classList.remove('hidden');
      updateModeDisplay();
      updateDisplay();
      selectedIcon = '‚≠ê';
      updateIconPreview(selectedIcon);
    }

    window.onclick = function(e){
      document.querySelectorAll('.modal').forEach(m=>{ if(e.target===m) m.style.display='none'; });
    };

    function showBanner(message, type = 'success') {
      const existing = document.getElementById('notificationBanner');
      if (existing) existing.remove();
      const banner = document.createElement('div');
      banner.id = 'notificationBanner';
      banner.className = `notification-banner ${type}`;
      banner.textContent = message;
      banner.setAttribute('role', 'status');
      banner.setAttribute('aria-live', 'polite');
      document.body.appendChild(banner);
      setTimeout(() => banner.classList.add('show'), 50);
      setTimeout(() => {
        banner.classList.remove('show');
        setTimeout(() => banner.remove(), 400);
      }, 3000);
    }
    function showToast(msg, type = '') {
      const bannerType = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      showBanner(msg, bannerType);
    }

    function initApp(){
      loadData();
    }
    initApp();
  </script>
</body>
</html>
