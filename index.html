<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>I Gettoni di Clizia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Set Firestore log level to debug for development
    setLogLevel('debug');

    // Global variables from the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase initialization
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    
    // Main data structure
    let data = {
      piggies: {
        "piggy-1": { name: "Ricompense", balance: 0, rewards: [], icon: "⭐", id: "piggy-1" }
      },
      currentPiggyId: "piggy-1",
      rewards: {}
    };
    
    // UI elements
    const mainApp = document.getElementById('mainApp');
    const piggyBankList = document.getElementById('piggyBankList');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const rewardNameInput = document.getElementById('rewardName');
    const rewardValueInput = document.getElementById('rewardValue');
    const addRewardForm = document.getElementById('addRewardForm');
    const newRewardButton = document.getElementById('newRewardButton');
    const addTokenButton = document.getElementById('addToken');
    const removeTokenButton = document.getElementById('removeToken');
    const tokenValue = document.getElementById('tokenValue');
    const addPiggyForm = document.getElementById('addPiggyForm');
    const newPiggyButton = document.getElementById('newPiggyButton');
    const piggyNameInput = document.getElementById('piggyName');
    const piggyIconInput = document.getElementById('piggyIcon');
    const modal = document.getElementById('modal');
    const closeModalButton = document.getElementById('closeModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalTitle = document.getElementById('modalTitle');
    
    // Check if Firebase is configured before initializing
    if (Object.keys(firebaseConfig).length > 0) {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      
      // Listen for auth state changes
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          isAuthReady = true;
          mainApp.classList.remove('hidden');
          // Start listening to the database in real-time
          listenForData();
        } else {
          // Sign in anonymously if no user is found
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
            } else {
              await signInAnonymously(auth);
            }
          } catch(error) {
            showToast(`Errore di autenticazione: ${error.message}`, 'error');
            console.error("Auth error:", error);
          }
        }
      });
    } else {
      showToast("Firebase non è configurato correttamente. Per favore, carica i file su un ambiente che supporta Firebase.", 'error');
      console.error("Firebase config is missing.");
    }
    
    // Utility functions
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500');
      if (type === 'success') {
        toast.classList.add('bg-green-500');
      } else if (type === 'error') {
        toast.classList.add('bg-red-500');
      } else {
        toast.classList.add('bg-blue-500');
      }
      toast.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        toast.classList.remove('show');
      }, 2200);
    }
    
    function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.classList.remove('hidden');
    }
    
    closeModalButton.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    // --- Firebase & Data Management ---
    
    function listenForData() {
        if (!isAuthReady || !db || !userId) return;
        
        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/piggies`, 'all_data');
        
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const fetchedData = docSnap.data();
                data.piggies = fetchedData.piggies;
                data.rewards = fetchedData.rewards;
                
                // Ensure the currentPiggyId is still valid
                if (!data.piggies[data.currentPiggyId]) {
                    data.currentPiggyId = Object.keys(data.piggies)[0];
                }
                
                updateModeDisplay();
                updateDisplay();
                showToast("Dati aggiornati in tempo reale!", "success");
            } else {
                console.log("Nessun documento trovato. Creazione di un nuovo documento...");
                // Create initial data if it doesn't exist
                saveData();
            }
        }, (error) => {
            console.error("Errore onSnapshot:", error);
            showToast("Errore durante il caricamento dei dati: " + error.message, "error");
        });
    }
    
    async function saveData() {
        if (!isAuthReady || !db || !userId) {
            showToast("Errore: Utente non autenticato o database non pronto.", "error");
            return;
        }
        
        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/piggies`, 'all_data');
        try {
            await setDoc(docRef, {
                piggies: data.piggies,
                rewards: data.rewards,
            });
            showToast("Dati salvati su Cloud!", "success");
        } catch (error) {
            console.error("Errore salvataggio dati:", error);
            showToast("Errore durante il salvataggio dei dati: " + error.message, "error");
        }
    }
    
    // --- UI Logic ---
    
    function updateDisplay() {
        // Update piggy bank list
        piggyBankList.innerHTML = '';
        const currentPiggy = data.piggies[data.currentPiggyId];
        if (!currentPiggy) {
          showToast("Nessun salvadanaio disponibile.", "error");
          tokenDisplay.textContent = '0';
          return;
        }

        Object.values(data.piggies).forEach(piggy => {
          const li = document.createElement('li');
          const isSelected = piggy.id === data.currentPiggyId;
          const classList = [
            'py-2', 'px-4', 'rounded-full', 'cursor-pointer', 'transition-colors', 'duration-200',
            isSelected ? 'bg-pink-500 text-white' : 'bg-pink-100 text-pink-700 hover:bg-pink-200',
            'mr-2', 'mb-2', 'flex', 'items-center', 'shadow-md', 'border-2', 'border-pink-300'
          ];
          li.className = classList.join(' ');
          li.innerHTML = `<span class="text-2xl mr-2">${piggy.icon}</span> ${piggy.name}`;
          li.onclick = () => {
              data.currentPiggyId = piggy.id;
              updateModeDisplay();
              updateDisplay();
          };
          
          if (Object.values(data.piggies).length > 1) {
              const deleteBtn = document.createElement('button');
              deleteBtn.innerHTML = '❌';
              deleteBtn.className = 'ml-auto text-pink-300 hover:text-red-500 text-lg transition-colors duration-200';
              deleteBtn.onclick = (e) => {
                  e.stopPropagation();
                  deletePiggy(piggy.id);
              };
              li.appendChild(deleteBtn);
          }
          piggyBankList.appendChild(li);
        });

        tokenDisplay.textContent = currentPiggy.balance;
        updateRewardsList(currentPiggy.rewards);
        document.getElementById('currentPiggyName').textContent = currentPiggy.name;
    }

    function updateRewardsList(rewards) {
      const rewardsList = document.getElementById('rewardsList');
      rewardsList.innerHTML = '';
      if (rewards.length === 0) {
        rewardsList.innerHTML = '<p class="text-center text-gray-500 italic mt-4">Nessuna ricompensa ancora. Aggiungine una!</p>';
        return;
      }
      
      rewards.sort((a, b) => data.rewards[a].value - data.rewards[b].value).forEach(rewardId => {
        const reward = data.rewards[rewardId];
        if (!reward) return; // Skip if reward is not found
        
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-4 transform hover:scale-105 transition-transform duration-200 border-2 border-purple-200';
        li.innerHTML = `
          <div>
            <span class="text-3xl mr-3">${reward.icon}</span>
            <span class="font-bold text-lg text-purple-800">${reward.name}</span>
            <p class="text-sm text-gray-500">Costo: ${reward.value}</p>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="redeemReward('${reward.id}')" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-full font-bold shadow-md transition-transform duration-200 hover:scale-110">
              Riscatta
            </button>
            <button onclick="deleteReward('${reward.id}')" class="text-red-500 hover:text-red-700 transition-colors duration-200">
              <span class="text-xl">❌</span>
            </button>
          </div>
        `;
        rewardsList.appendChild(li);
      });
    }

    // --- Actions ---
    
    function updateTokenValue() {
        const value = parseInt(tokenValue.value, 10);
        if (isNaN(value) || value < 1) {
            tokenValue.value = 1;
        }
    }
    tokenValue.addEventListener('input', updateTokenValue);

    function changeToken(amount) {
      const currentPiggy = data.piggies[data.currentPiggyId];
      if (!currentPiggy) return;
      const value = parseInt(tokenValue.value, 10) || 1;
      const newBalance = currentPiggy.balance + amount * value;
      
      if (newBalance < 0) {
          showToast("Non puoi avere gettoni negativi!", "error");
          return;
      }
      
      currentPiggy.balance = newBalance;
      saveData();
      updateDisplay();
    }
    
    addTokenButton.addEventListener('click', () => changeToken(1));
    removeTokenButton.addEventListener('click', () => changeToken(-1));

    addRewardForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const piggy = data.piggies[data.currentPiggyId];
        if (!piggy) return;
        
        const name = rewardNameInput.value.trim();
        const value = parseInt(rewardValueInput.value, 10);
        const icon = document.getElementById('rewardIcon').value;
        
        if (name && !isNaN(value) && value > 0) {
            const rewardId = `reward-${Date.now()}`;
            data.rewards[rewardId] = {
                id: rewardId,
                name: name,
                value: value,
                icon: icon
            };
            piggy.rewards.push(rewardId);
            saveData();
            addRewardForm.reset();
            updateModeDisplay();
            updateDisplay();
        } else {
             showModal('Errore', 'Per favore, inserisci un nome e un valore valido per la ricompensa.');
        }
    });
    
    function redeemReward(id) {
        const currentPiggy = data.piggies[data.currentPiggyId];
        if (!currentPiggy) return;
        const reward = data.rewards[id];
        
        if (reward && currentPiggy.balance >= reward.value) {
            currentPiggy.balance -= reward.value;
            delete data.rewards[id];
            currentPiggy.rewards = currentPiggy.rewards.filter(rid => rid !== id);
            saveData();
            showToast("Ricompensa riscattata!", "success");
            updateDisplay();
        } else {
             showModal('Errore', 'Non hai abbastanza gettoni per riscattare questa ricompensa!');
        }
    }
    
    function deleteReward(id) {
        const currentPiggy = data.piggies[data.currentPiggyId];
        if (!currentPiggy) return;
        delete data.rewards[id];
        currentPiggy.rewards = currentPiggy.rewards.filter(rid => rid !== id);
        saveData();
        updateDisplay();
    }
    
    addPiggyForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = piggyNameInput.value.trim();
      const icon = piggyIconInput.value;
      if (name) {
          const newPiggyId = `piggy-${Date.now()}`;
          data.piggies[newPiggyId] = {
              id: newPiggyId,
              name: name,
              balance: 0,
              rewards: [],
              icon: icon
          };
          data.currentPiggyId = newPiggyId;
          saveData();
          addPiggyForm.reset();
          updateModeDisplay();
          updateDisplay();
      } else {
          showModal('Errore', 'Il nome del salvadanaio non può essere vuoto.');
      }
    });
    
    function deletePiggy(id) {
      if (Object.keys(data.piggies).length > 1) {
        delete data.piggies[id];
        const remainingPiggies = Object.values(data.piggies);
        data.currentPiggyId = remainingPiggies[0].id;
        saveData();
        updateModeDisplay();
        updateDisplay();
      } else {
        showModal('Attenzione', 'Non puoi eliminare l\'unico salvadanaio rimasto!');
      }
    }
    
    // UI Mode Switching
    function updateModeDisplay() {
        // Hide all main content sections
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('addRewardSection').classList.add('hidden');
        document.getElementById('piggyBankManagement').classList.add('hidden');

        // Show the selected section
        switch(document.getElementById('modeSelector').value) {
            case 'tokens':
                document.getElementById('mainContent').classList.remove('hidden');
                break;
            case 'rewards':
                document.getElementById('addRewardSection').classList.remove('hidden');
                break;
            case 'piggy-management':
                document.getElementById('piggyBankManagement').classList.remove('hidden');
                break;
        }
    }
    document.getElementById('modeSelector').addEventListener('change', updateModeDisplay);
    
    function updateIconPreview(icon) {
        const previewEl = document.getElementById('iconPreview');
        if (previewEl) previewEl.textContent = icon;
    }
    const iconSel = document.getElementById('rewardIcon');
    if (iconSel) iconSel.addEventListener('change', (e) => updateIconPreview(e.target.value));

    // Initial check for Firebase config and start the app
    if (Object.keys(firebaseConfig).length > 0) {
      document.getElementById('mainApp').classList.remove('hidden');
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; color: #fff; text-align: center;
      border-radius: 9999px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
      font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.5s ease-in-out;
    }
    .toast.show { visibility: visible; animation: fadeIn 0.5s, fadeOut 0.5s 2s; }
    @keyframes fadeIn { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
    @keyframes fadeOut { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
    
    .modal {
        background-color: rgba(0, 0, 0, 0.5);
    }
  </style>

  <div id="mainApp" class="min-h-screen bg-pink-50 p-4 sm:p-8 flex flex-col items-center hidden">
    <div class="container bg-white rounded-3xl shadow-2xl p-6 sm:p-10 w-full max-w-2xl mb-8 border-4 border-pink-200">
      <div class="text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-pink-600 mb-2">I Gettoni di <span class="text-purple-600">Clizia</span></h1>
        <p class="text-lg sm:text-xl text-gray-500 font-medium">Gestisci i tuoi gettoni e le tue ricompense!</p>
      </div>

      <div class="mb-6 flex flex-col sm:flex-row items-center justify-between">
        <div class="flex items-center space-x-2 bg-pink-100 p-2 rounded-full mb-4 sm:mb-0">
          <label for="modeSelector" class="font-bold text-gray-700">Modalità:</label>
          <select id="modeSelector" class="bg-white p-2 rounded-full border-2 border-pink-300">
            <option value="tokens">Gestione Gettoni</option>
            <option value="rewards">Aggiungi Ricompensa</option>
            <option value="piggy-management">Gestisci Salvadanai</option>
          </select>
        </div>

        <div class="flex items-center space-x-2">
            <h2 class="text-2xl font-bold text-pink-700">Salvadanaio:</h2>
            <div class="bg-purple-100 text-purple-800 font-bold py-2 px-4 rounded-full text-xl shadow-md">
                <span id="currentPiggyName"></span>
            </div>
        </div>
      </div>
      
      <!-- Sezione Gestione Gettoni -->
      <div id="mainContent">
        <div class="flex flex-col items-center mb-8">
          <h2 class="text-6xl sm:text-8xl font-black text-center text-pink-500 token-display-shadow transition-transform duration-300 transform scale-100" id="tokenDisplay">0</h2>
          <div class="flex items-center justify-center space-x-2 mt-4">
            <input type="number" id="tokenValue" value="1" min="1" class="w-24 text-center p-2 rounded-full border-2 border-pink-300 text-gray-700 font-bold focus:outline-none focus:ring-2 focus:ring-pink-500 transition-all duration-200" />
            <button id="addToken" class="w-12 h-12 text-2xl font-bold rounded-full bg-green-500 text-white shadow-lg transform hover:scale-110 active:scale-95 transition-transform duration-200">
              +
            </button>
            <button id="removeToken" class="w-12 h-12 text-2xl font-bold rounded-full bg-red-500 text-white shadow-lg transform hover:scale-110 active:scale-95 transition-transform duration-200">
              -
            </button>
          </div>
        </div>

        <!-- Lista ricompense -->
        <div class="text-center mb-6">
          <h3 class="text-3xl font-bold text-pink-600 mb-4">Le Tue Ricompense</h3>
        </div>
        <ul id="rewardsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Le ricompense saranno aggiunte qui da JavaScript -->
        </ul>
      </div>

      <!-- Sezione Aggiungi Ricompensa -->
      <div id="addRewardSection" class="hidden">
        <h3 class="text-3xl font-bold text-center text-purple-600 mb-6">Aggiungi una Nuova Ricompensa</h3>
        <form id="addRewardForm" class="bg-purple-50 p-6 rounded-2xl shadow-inner border-2 border-purple-200">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="rewardName" class="block text-gray-700 font-bold mb-2">Nome della Ricompensa</label>
              <input type="text" id="rewardName" required class="w-full p-3 rounded-xl border-2 border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Es. Gelato" />
            </div>
            <div>
              <label for="rewardValue" class="block text-gray-700 font-bold mb-2">Costo (Gettoni)</label>
              <input type="number" id="rewardValue" required min="1" class="w-full p-3 rounded-xl border-2 border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Es. 10" />
            </div>
          </div>
          <div class="mb-6">
            <label for="rewardIcon" class="block text-gray-700 font-bold mb-2">Icona (emoji)</label>
            <div class="flex items-center space-x-2">
              <select id="rewardIcon" class="flex-grow p-3 rounded-xl border-2 border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="⭐">⭐ Stella</option>
                <option value="🍕">🍕 Pizza</option>
                <option value="🎮">🎮 Joystick</option>
                <option value="📚">📚 Libro</option>
                <option value="💰">💰 Soldi</option>
                <option value="🎈">🎈 Palloncino</option>
                <option value="🎨">🎨 Tavolozza</option>
                <option value="🎬">🎬 Film</option>
                <option value="🍦">🍦 Gelato</option>
                <option value="🎁">🎁 Regalo</option>
                <option value="🧸">🧸 Orsacchiotto</option>
                <option value="🚀">🚀 Razzo</option>
                <option value="👑">👑 Corona</option>
                <option value="🏆">🏆 Trofeo</option>
                <option value="🎉">🎉 Festa</option>
                <option value="🌈">🌈 Arcobaleno</option>
              </select>
              <span id="iconPreview" class="text-3xl">⭐</span>
            </div>
          </div>
          <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 rounded-full text-lg shadow-lg transform hover:scale-105 active:scale-95 transition-transform duration-200">
            Aggiungi Ricompensa
          </button>
        </form>
      </div>
      
      <!-- Sezione Gestisci Salvadanai -->
      <div id="piggyBankManagement" class="hidden">
        <h3 class="text-3xl font-bold text-center text-pink-600 mb-6">Gestisci i Tuoi Salvadanai</h3>
        
        <div class="mb-6">
          <h4 class="text-2xl font-bold text-gray-700 mb-3">Salvadanaio Corrente:</h4>
          <ul id="piggyBankList" class="flex flex-wrap items-center">
            <!-- I salvadanai saranno aggiunti qui -->
          </ul>
        </div>
        
        <h4 class="text-2xl font-bold text-gray-700 mb-3">Aggiungi un nuovo salvadanaio:</h4>
        <form id="addPiggyForm" class="bg-pink-50 p-6 rounded-2xl shadow-inner border-2 border-pink-200">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="piggyName" class="block text-gray-700 font-bold mb-2">Nome Salvadanaio</label>
              <input type="text" id="piggyName" required class="w-full p-3 rounded-xl border-2 border-pink-300 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Es. Viaggio al mare" />
            </div>
            <div>
              <label for="piggyIcon" class="block text-gray-700 font-bold mb-2">Icona (emoji)</label>
              <select id="piggyIcon" class="w-full p-3 rounded-xl border-2 border-pink-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
                  <option value="🐖">🐖 Salvadanaio</option>
                  <option value="🚀">🚀 Obiettivo</option>
                  <option value="🏖️">🏖️ Spiaggia</option>
                  <option value="🎮">🎮 Gioco</option>
                  <option value="📚">📚 Scuola</option>
              </select>
            </div>
          </div>
          <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold py-3 rounded-full text-lg shadow-lg transform hover:scale-105 active:scale-95 transition-transform duration-200">
            Crea Salvadanaio
          </button>
        </form>
      </div>

    </div>
  </div>
  
  <div id="toast" class="toast fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white p-3 rounded-full shadow-lg text-sm"></div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="bg-white rounded-lg p-8 mx-4 max-w-sm z-50 shadow-xl">
          <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
          <p id="modalMessage" class="mb-6"></p>
          <div class="flex justify-end">
              <button id="closeModal" class="bg-pink-500 text-white font-bold py-2 px-4 rounded-full hover:bg-pink-600 transition-colors duration-200">
                  OK
              </button>
          </div>
      </div>
  </div>
</body>
</html>
